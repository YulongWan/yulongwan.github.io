/*! Copyright (c) ZUIKU.COM - Author: LIJUN - Email: zwlijun@gmail.com */
define(function(require,exports,module){require("mod/polyfill/array.a477f3215c0d3d93dd46437020fc5c0c829c9f2b");var a=require("mod/polyfill/css.7891625883dcf7e67d40fc1000d57016eb4aa588"),b=require("mod/se/listener.222be46f03da5911721807bfda4b9b616035e3f6"),c=a.getRealPropertyName("transform"),d=a.getRealPropertyName("transition"),e=a.getRealPropertyName("animation"),f={UNKNOWN:"unknown",TRANSITION:"transition",ANIMATION:"animation",CLASS:"class"},g=function(a){this.name=a,this.frames=[]};g.prototype={push:function(b,d){if(-1==this.frames.indexOf(b)){var e=[],f="",g="",h=[];for(var i in d)d.hasOwnProperty(i)&&(g=d[i],a.isTransformMethod(i)?h.push(i+"("+g+")"):(f=a.getRealPropertyName(i),e.push(f+": "+g)));h.length>0&&e.push(c+": "+h.join(" ")),this.frames.push(b+" {"+e.join("; ")+"}")}},print:function(){var b=this.frames.join("\n"),c="keyframes",d=this.name,e=a.getVendorHackKey()+c,f=" "+d+" {\n"+b+"\n}",g=[];e!=c&&g.push("@"+e+f),g.push("@"+c+f),$("head").append('<style type="text/css">\n'+g.join("\n")+"\n</style>")}};var h=function(a,c,d){this.target=$(a),this.domNode=this.target[0],this.backupStyle=this.domNode.style.cssText,this.runtimeStyle=this.backupStyle,this.backupClass=this.domNode.className,this.runtimeClass=this.backupClass,this.source=c,this.current=0,this.type=f.TRANSITION,this.queue=this.parse(c),this.keyframes={},this.animationIndex=0,this.listener=new b({ontransitionend:null,onanimationstart:null,onanimationend:null,onanimationiteration:null,onplay:null,onplaying:null,onreset:null,oncomplete:null}),!1!==d&&this.on()};h.prototype={exec:function(a,b){return this.listener.exec(a,b)},set:function(a,b){this.listener.set(a,b)},remove:function(a){this.listener.remove(a)},get:function(a){return this.listener.get(a)},clear:function(){this.listener.clear()},off:function(){var a=this,b=a.target;b.off("webkitAnimationStart","").off("webkitAnimationEnd","").off("webkitAnimationIteration","").off("webkitTransitionEnd","")},on:function(a){var b=this,c=b.target,d=c.attr("data-bindla");("1"!=d||!0===a)&&(b.off(),c.on("webkitAnimationStart","",b,function(a){var b=a.data;b.animationStart(a)}),c.on("webkitAnimationEnd","",b,function(a){var b=a.data;b.animationEnd(a)}),c.on("webkitAnimationIteration","",b,function(a){var b=a.data;b.animationIteration(a)}),c.on("webkitTransitionEnd","",b,function(a){var b=a.data;b.transitionEnd(a)}))},animationStart:function(b){b.preventDefault(),b.stopPropagation();var c=this;c.exec("animationstart",[b,c.target,c.current]);var d="animationIterationCount",e=a.getRealStyle(d),f=c.domNode.style[d];e&&(f=c.domNode.style[e]),"infinite"==f&&(c.current++,c.__play__())},animationEnd:function(a){a.preventDefault(),a.stopPropagation();var b=this;b.exec("animationend",[a,b.target,b.current]),b.current++,b.__play__()},animationIteration:function(a){a.preventDefault(),a.stopPropagation();var b=this;b.exec("animationiteration",[a,b.target,b.current])},transitionEnd:function(a){a.preventDefault(),a.stopPropagation();var b=this,c=b.getWidgetCurrentStyle("transition"),d=c.split(",").length,e=++b.animationIndex;d==e&&(b.exec("transitionend",[a,b.target,b.current]),b.current++,b.animationIndex=0,b.__play__())},parse:function(a){var b="::",c=a.indexOf(b),d=a.substring(0,c),e=a.substr(c+b.length);if(this.type=d,f.TRANSITION==d)return this.parseTransition(e);if(f.ANIMATION==d)return this.parseAnimation(e);if(f.CLASS==d)return this.parseClassName(e);throw this.type=f.UNKNOWN,new Error("Unknown animation schema("+d+")")},parseTransition:function(b){for(var e=b.split(">"),f=e.length,g=null,h=null,i=/^([^:]+):([^!]+)!(.+)?$/g,j=null,k=null,l=[],m=!1,n=[],o=0;f>o;o++){l=[],m=!1,g=e[o],k={properties:[],values:[],animate:[]},h=g.split(";");for(var p=0,q=h.length;q>p;p++)for(;null!=(j=i.exec(h[p]));){var r=j[1],s=j[2],t=j[3]||"",u=a.getRealPropertyName(r),v=a.cssname(u);a.isTransformMethod(r)?(l.push(r+"("+s+")"),t&&!1===m&&(k.values.push(c+" "+t),m=!0)):(k.properties.push(v+": "+s),t&&k.values.push(v+" "+t))}l.length>0&&k.properties.push(c+": "+l.join(" ")),k.animate.push(d+": "+k.values.join(", ")),n.push(k)}return n},parseAnimation:function(a){for(var b=a.split(">"),c=b.length,d=null,f=null,g=/^([^:]+):([^!]*)!(.+)?$/g,h=null,i=null,j=[],k=0;c>k;k++){for(d=b[k],i={properties:[],values:[],animate:[]},f=d;null!=(h=g.exec(f));){var l=h[1],m=(h[2],h[3]||"");i.values.push(l+" "+m)}i.animate.push(e+": "+i.values.join(", ")),j.push(i)}return j},parseClassName:function(a){for(var b=a.split(">"),c=b.length,d=null,e=null,f=/^([^:!]+)!(.+)?$/g,g=null,h=null,i=[],j=0;c>j;j++){for(d=b[j],h={properties:[],values:[],animate:[]},e=d;null!=(g=f.exec(e));){var k=g[1],l=g[2];h.properties.push(k),h.values.push("true"===l)}i.push(h)}return i},clearKeyFrames:function(){this.keyframes={}},addKeyFrame:function(a,b,c){a in this.keyframes||(this.keyframes[a]=new g(a)),this.keyframes[a].push(b,c)},printKeyFrames:function(){for(var a in this.keyframes)this.keyframes[a].print()},mergerCss:function(a,b,c){var d=/(;\s*)$/g,e=a.replace(d,""),f=b.replace(d,""),g=(c||"").split(":")[1]||"",h=(e?e+";":"")+(f?f+";":"")+(g&&g.length>1?c:"");return h},__play__:function(){var a=this.queue[this.current];if(a){var b=a.properties,c=a.values,d=a.animate;if(f.CLASS==this.type)!0===c[0]?this.target.addClass(b[0]):this.target.removeClass().addClass(this.backupClass+" "+b[0]),this.runtimeClass=this.domNode.className;else{var e=this.mergerCss(this.runtimeStyle,b.join(";"),d.join(";"));this.runtimeStyle=this.domNode.style.cssText=e}this.exec("playing",[this.target,this.current]),0==a.values.length&&(this.current++,this.__play__())}else this.exec("complete",[this.target])},updateSource:function(a){this.source=a,this.queue=this.parse(a)},updateTarget:function(a){this.target=$(a),this.domNode=this.target[0],this.backupStyle=this.domNode.style.cssText,this.runtimeStyle=this.backupStyle,this.backupClass=this.domNode.className,this.runtimeClass=this.backupClass},getWidgetCurrentStyle:function(b){return a.getRealComputedStyle(this.target,b)},setWidgetCurrentStyle:function(b,c){a.css(this.target,b,c)},play:function(){var a=this;a.reset(),a.__play__();var b="0s",c="0s",d=a.type,e="s",g=0,h=0,i=0;f.TRANSITION==d?(b=a.getWidgetCurrentStyle("transition-duration"),c=a.getWidgetCurrentStyle("transition-delay")):f.ANIMATION==d?(b=a.getWidgetCurrentStyle("animation-duration"),c=a.getWidgetCurrentStyle("animation-delay")):f.CLASS==d&&(b=a.getWidgetCurrentStyle("animation-duration")||a.getWidgetCurrentStyle("transition-duration"),c=a.getWidgetCurrentStyle("animation-delay")||a.getWidgetCurrentStyle("transition-delay")),c&&(c=c.toLowerCase(),e=-1==c.indexOf("ms")?"s":"ms",g=Number(c.substring(0,c.indexOf(e))),"s"==e&&(g=1e3*g)),b&&(b=b.toLowerCase(),e=-1==b.indexOf("ms")?"s":"ms",h=Number(b.substring(0,b.indexOf(e))),"s"==e&&(h=1e3*h),i=Math.min(Math.max(.05*h,32),64)),setTimeout(function(){a.exec("play",[a.target])},g+i)},reset:function(){f.CLASS==this.type?this.domNode.className=this.runtimeClass=this.backupClass:this.domNode.style.cssText=this.runtimeStyle=this.backupStyle,this.animationIndex=0,this.current=0,this.exec("reset",[this.target])}};var i={newInstance:function(a,b,c){var d=new h(a,b,c);return{target:d.target,set:function(a,b){return d.set(a,b),this},addKeyFrame:function(a,b,c){return d.addKeyFrame(a,b,c),this},printKeyFrames:function(){return d.printKeyFrames(),this},clearKeyFrames:function(){return d.clearKeyFrames(),this},updateTarget:function(a){return d.updateTarget(a),this},source:function(a){return d.updateSource(a),this},play:function(){return setTimeout(function(){d.play()},60),this},reset:function(){return d.reset(),this},off:function(){return d.off(),this},on:function(a){return d.on(a),this},getWidgetCurrentStyle:function(a){return d.getWidgetCurrentStyle(a)},setWidgetCurrentStyle:function(a,b){return d.setWidgetCurrentStyle(a,b),this}}}};module.exports=i});
