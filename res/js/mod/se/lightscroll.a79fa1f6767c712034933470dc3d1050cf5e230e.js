/*! Copyright (c) ZUIKU.COM - Author: LIJUN - Email: zwlijun@gmail.com */
define(function(require,exports,module){require("mod/zepto/touch.04773a73dab25f8dec79dbccd3fafa440f77f81d");var a=require("mod/se/listener.222be46f03da5911721807bfda4b9b616035e3f6"),b=$.Util=require("mod/se/util.f9a416ff84aa85b8ba737234874f8969ce70e034"),c=require("mod/polyfill/css.7891625883dcf7e67d40fc1000d57016eb4aa588"),d=(require("mod/se/timer.74b69eae4780be6b48bedbac0cb9dc301018987f"),a.HandleStack),e="ontouchstart"in window,f=e?"touchstart":"mousedown",g=e?"touchend":"mouseup",h=e?"touchmove":"mousemove",i=function(b,c,e){this.viewer=$(b),this.scroller=$(c?c:this.viewer.children().get(0)),this.ratio=e||1,this.direction=this.viewer.attr("data-dir")||"v",this.shiftDistance=Number(this.viewer.attr("data-shift")||0),this.overDistance=Number(this.viewer.attr("data-over")||0),this.bind=!1,this.handleStack=new d,this.listener=new a({onstart:null,onscrolling:null,onend:null,onpushready:null,onpullready:null,onpush:null,onpull:null,onblock:null},this.handleStack),this.refresh()};i.prototype={exec:function(a,b){return this.listener.exec(a,b)},set:function(a,b){this.listener.set(a,b)},remove:function(a){this.listener.remove(a)},get:function(a){return this.listener.get(a)},clear:function(){this.listener.clear()},getHandleStack:function(){return this.handleStack},cleanBoxStyle:function(){this.viewer.css("width","").css("height",""),this.scroller.css("width","").css("height","")},refresh:function(){var a=0,b=0;this.cleanBoxStyle(),a=this.viewer.offset(),b=this.scroller.offset(),this.viewerbox={width:a.width/this.ratio,height:a.height/this.ratio},this.scrollerbox={width:b.width/this.ratio,height:b.height/this.ratio},this.maxScrollX=this.scrollerbox.width-this.viewerbox.width+("h"==this.direction?this.overDistance:0),this.maxScrollY=this.scrollerbox.height-this.viewerbox.height+("h"==this.direction?0:this.overDistance),this.ZERO={x:"0",y:"0"},this.MAX={x:-this.maxScrollX,y:-this.maxScrollY},this.viewerbox.width>0&&this.viewerbox.height>0&&this.viewer.css({width:this.viewerbox.width+"px",height:this.viewerbox.height+"px",overflow:"hidden"}),this.scrollerbox.width>0&&this.scrollerbox.height>0&&this.scroller.css({width:this.scrollerbox.width+"px",height:this.scrollerbox.height+"px"})},scrollTo:function(a){var d=this.direction,e="matrix(${a}, ${b}, ${c}, ${d}, ${x}, ${y})",f={a:"1",b:"0",c:"0",d:"1",x:"0",y:"${y}"};"h"==d&&(f=$.extend(f,{x:"${x}",y:"0"}));var g=JSON.stringify(f),h=JSON.parse(b.formatData(g,a)),i=b.formatData(e,h);c.css(this.scroller,"transform",i)},minimum:function(){this.scrollTo(this.ZERO)},maximum:function(){this.scrollTo(this.MAX)},configure:function(){var a=this,b=a.direction,c=a.viewerbox,d=a.scrollerbox,e=a.viewer,i=(a.scroller,0),j=0,k=0,l=0,m=0,n=0,o=!1,p=!1,q=!1;if("h"==b){if(d.width<=c.width)return a.exec("block",["minimum/width"]),0}else if(d.height<=c.height)return a.exec("block",["minimum/height"]),0;return!0===this.bind?(a.exec("block",["bind"]),0):(e.on(f,function(b){var c="changedTouches"in b?b.changedTouches[0]:b,d=i=c.pageX,e=j=c.pageY;o=!0,p=!1,q=!1,a.exec("start",[b,d,e])}).on(h,function(c){if(!o)return 0;var d="changedTouches"in c?c.changedTouches[0]:c,e=d.pageX,f=d.pageY,g=k=e+m-i,h=l=f+n-j,r={x:g,y:h};a.scrollTo(r);var s="h"==b?g:h,t="h"==b?a.maxScrollX:a.maxScrollY;p=!1,q=!1,s>0&&s>=a.shiftDistance?(p=!0,a.exec("pullready",[c,g,h])):0>s&&Math.abs(s)>=a.shiftDistance+t?(q=!0,a.exec("pushready",[c,g,h])):a.exec("scrolling",[c,g,h])}).on(g,function(c){o=!1;var d=("changedTouches"in c?c.changedTouches[0]:c,m=k),e=n=l,f="h"==b?d:e,g="h"==b?a.maxScrollX:a.maxScrollY,h=Math.abs(f);f>0?(m=n=0,a.minimum()):0>f&&h>g&&(m=-a.maxScrollX,n=-a.maxScrollY,a.maximum()),a.exec("end",[c,m,n]),!0===p&&a.exec("pull",[c,k,l]),!0===q&&a.exec("push",[c,k,l])}),void(this.bind=!0))}},i.Cache={},module.exports={getInstance:function(a,b,c,d){var e=i.Cache[a]||(i.Cache[a]=new i(b,c,d));return{version:"B15R0624",viewer:e.viewer,scroller:e.scroller,ratio:e.ratio,set:function(a,b){return e.set(a,b),this},getHandleStack:function(){return e.getHandleStack()},refresh:function(){return e.refresh(),this},scrollTo:function(a){return e.scrollTo(a),this},minimum:function(){return e.minimum(),this},maximum:function(){return e.maximum(),this},getMaxScrollY:function(){return e.maxScrollY},getMaxScrollX:function(){return e.maxScrollX},getViewerBox:function(){return e.viewerbox},getScrollerBox:function(){return e.scrollerbox},getZeroPoint:function(){return e.ZERO},getMaxPoint:function(){return e.MAX},configure:function(){return e.configure(),this}}}}});
