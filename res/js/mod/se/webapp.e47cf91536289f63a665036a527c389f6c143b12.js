/*! Copyright (c) ZUIKU.COM - Author: LIJUN - Email: zwlijun@gmail.com */
define(function(require,exports,module){require("mod/zepto/touch.04773a73dab25f8dec79dbccd3fafa440f77f81d");var a=require("mod/se/listener.222be46f03da5911721807bfda4b9b616035e3f6"),b=$.Util=require("mod/se/util.23a019fe7e11928066d996128afdbb397a6fc330"),c=require("mod/sa/lightanimation.99760309ab7605392af133a11d24707db2120108"),d=require("mod/sa/scenetransitions.13dfb4facc16fc358b1e1eb748983e2eda2d2073"),e=require("mod/polyfill/css.7891625883dcf7e67d40fc1000d57016eb4aa588"),f=require("mod/se/timer.74b69eae4780be6b48bedbac0cb9dc301018987f"),g=a.HandleStack,h=e.hasProperty("perspective")?"translateZ(0)":"",i="ontouchstart"in window,j=i?"touchstart":"mousedown",k=i?"touchend":"mouseup",l=i?"touchmove":"mousemove",m={VERTICAL:"vertical",HORIZONTAL:"horizontal"},n={ONCE:"once",EVERYTIME:"everytime"},o={HEIGHT:"height",WIDTH:"width",CONTAIN:"contain",COVER:"cover"},p=function(a,module,b,c){this.app=a,this.module=module,this.widget=b,this.source=c,this.effect=this.createAnimate(c)};p.prototype={createAnimate:function(a){var b=c.newInstance(this.widget,a);return b.set("complete",{callback:function(){this.app.exec("widgetcomplete",[this.module,this.widget])},context:this}),b.set("play",{callback:function(){this.app.exec("widgetplay",[this.module,this.widget])},context:this}),b.set("reset",{callback:function(){this.app.exec("widgetreset",[this.module,this.widget])},context:this}),b.set("playing",{callback:function(a,b){this.app.exec("widgetplaying",[this.module,this.widget,b])},context:this}),b},update:function(a){this.effect.source(a)},next:function(){this.effect.play()},restore:function(){this.effect.reset()}};var q=function(b,c,e,f){var h=$("#"+b),i=$("#"+c),j=$("#"+e),k=$("#"+f);if(!b||!c||1!=h.length||1!=i.length)throw new Error("APP is not valid, appId = "+b+", viewId = "+c);if(e&&1!=j.length)throw new Error("APP's `header` is not found("+e+")");if(f&&1!=k.length)throw new Error("APP's `footer` is not found("+f+")");1!=j.length&&(j=null),1!=k.length&&(k=null);var l=h.attr("data-snap");this.root=$("html"),this.appId=b,this.viewId=c,this.headerId=e,this.footerId=f,this.app=h,this.view=i,this.header=j,this.footer=k,this.appKey=h.attr("data-appkey"),this.snaps=l?h.find(l):[],this.widgets={},this.modules=$(".webapp-view>section"),this.innerboxes=$(".webapp-view>section>.innerbox"),this.mode=h.attr("data-mode")||"screen",this.scroll=h.attr("data-scroll")||m.VERTICAL,this.widgetMode=h.attr("data-widget-mode")||n.ONCE,this.design={width:640,height:1010},this.adaptor=h.attr("data-adaptor")||o.HEIGHT,this.currentIndex=0,this.lazyLoading=2,this.locked=!1,this.forcedLock=!1,this.preventResize=!1,this.touchEnabled="true"===(h.attr("data-touch")||"true"),this.sceneLoop="true"===(h.attr("data-scene-loop")||"true"),this.sceneMoveRatio=h.attr("data-scene-move")||.8,this.sceneShiftRatio=h.attr("data-scene-shift")||.2,this.sceneAttributes=h.attr("data-scene-attributes")||"deg:28;duration:1;timing:ease;perspective:300px;",this.sceneTransition=d.newInstance("section",this.mode,this.scroll,this.sceneLoop).import(),this.handleStack=new g,this.listener=new a({oncreatebefore:null,oninteractive:null,onready:null,oninit:null,oncreate:null,onlayout:null,onstart:null,onscrolling:null,onend:null,onexit:null,onvisible:null,onmovement:null,onblock:null,onshift:null,onresize:null,onupdate:null,onorientationchange:null,onwidgetcomplete:null,onwidgetplay:null,onwidgetplaying:null,onwidgetreset:null,onchromecreatebefore:null,onchromecreate:null,onchromestart:null,onchromescrolling:null,onchromeend:null,onchromeexit:null,onchromereset:null},this.handleStack)};q.prototype={exec:function(a,b){return this.listener.exec(a,b)},set:function(a,b){this.listener.set(a,b)},remove:function(a){this.listener.remove(a)},get:function(a){return this.listener.get(a)},clear:function(){this.listener.clear()},getHandleStack:function(){return this.handleStack},setLocked:function(a){this.locked=a||this.forcedLock,this.sceneTransition&&this.sceneTransition.setLocked(this.locked)},setPreventResize:function(a){this.preventResize=!0===a},setTouchEnabled:function(a){this.touchEnabled=!0===a,this.sceneTransition&&this.sceneTransition.setTouchEnabled(this.touchEnabled)},layout:function(a,c,d,e){$.each(c,function(a,c){var f=$(c);f.css({width:(d.width+"px").replace("%px","%"),height:(d.height+"px").replace("%px","%")}),offset=f.offset(),f.attr("data-index",a).attr("data-x",offset.left).attr("data-y",offset.top).attr("data-width",d.width).attr("data-height",d.height),b.execAfterMergerHandler(e,[a,f]),f=null}),this.exec("layout",[a,c,d])},calcLayoutSize:function(){var a=this,b=Math.max(document.documentElement.clientWidth,window.innerWidth||0),c=Math.max(document.documentElement.clientHeight,window.innerHeight||0),d=a.design,e=d.width,f=d.height,g=b/c,h=e/f,i=1;switch(a.adaptor){case o.CONTAIN:i=g>h?c/f:b/e;break;case o.COVER:i=g>h?b/e:c/f;break;case o.WIDTH:i=b/e;break;case o.HEIGHT:default:i=c/f}this.scaleRatio=i,this.viewSize={width:b,height:c},this.designSize={width:e,height:f},this.snapSize={width:e,height:f},this.update()},update:function(){var a=this,b=a.viewSize,c=a.designSize,d=a.snapSize;a.layout("view",a.view,{width:"100%",height:"100%"},{callback:function(a,b,c){b.attr("data-width",c.width).attr("data-height",c.height)},context:a,args:[b]}),a.layout("snap",a.snaps,d,null),a.layout("module",a.modules,{width:"100%",height:"100%"},{callback:function(a,module,b){module.attr("data-width",b.width).attr("data-height",b.height),this.queryModuleWidget(a,module)},context:a,args:[b]}),a.layout("innerbox",a.innerboxes,c,{callback:function(a,b,c,d){var f=$(b);f.css({position:"absolute",overflow:"hidden",left:"50%",top:"50%",margin:"-"+c.height/2+"px 0 0 -"+c.width/2+"px"}),e.css(f,"backface-visibility","hidden"),e.css(f,"transform-origin","center center 0"),e.css(f,"transform","scale("+d+", "+d+")")},args:[c,a.scaleRatio],context:a}),a.exec("update",[a.scaleRatio,b,c,d])},updateChrome:function(a,b){var c=this.scaleRatio,d=a.find("[data-chrome]"),e=a.find('[data-chrome-scroller="1"]'),f=e.length>0?e:d,g=d.attr("data-chrome-state");if("1"==g&&!0!==b)return 0;if("1"!=g&&(f.attr("data-backup",f[0].style.cssText),a.attr("data-backup",a[0].style.cssText)),"1"==g&&!0===b){var h=f.attr("data-backup")||"",i=a.attr("data-backup")||"";f[0].style.cssText=h,a[0].style.cssText=i}var j=f.offset(),k=0,l=0;j&&(k=j.width/c,l=j.height/c,k>0&&l>0&&f.attr("data-width",k).attr("data-height",l).css({width:k+"px",height:l+"px"})),j=a.offset(),k=0,l=0,j&&(k=j.width/c,l=j.height/c,k>0&&l>0&&a.attr("data-width",k).attr("data-height",l)),d.attr("data-chrome-state","1")},refreshChrome:function(module,a){for(var b=$(module)||$(this.modules[this.currentIndex]),c=b.find(".innerbox"),d=c.find('[data-chrome-box="1"]'),e=d.length>0?d:c,f=e.length,g=null,h=0;f>h;h++)g=$(e[h]),g.find("[data-chrome]").length>0&&this.updateChrome(g,a||!1)},preventTouchMove:function(){$(document).on("touchmove",function(a){a.preventDefault()})},queryModuleWidget:function(a,module){var b=this,c=null,d=String(a);b.widgets[d]||(c=module.find("[data-widget]"),b.widgets[d]=[],$.each(c,function(a,c){var e=$(c),f=e.attr("data-widget");f?b.widgets[d].push(new p(b,module,e,f)):e.removeAttr("data-widget")}))},updateModuleWidget:function(a){var b=this,c=null,d=String(a),module=$(b.modules[a]);b.widgets[d]?(c=module.find("[data-widget]"),$.each(c,function(a,c){var e=$(c),f=e.attr("data-widget"),g=b.widgets[d][a];g?f?g.update(f):(b.widgets[d][a]=null,b.widgets[d].splice(a,1)):f?b.widgets[d].push(new p(b,module,e,f)):e.removeAttr("data-widget")})):b.queryModuleWidget(a,module)},showModuleWidget:function(a){var b=this,c=b.widgets[String(a)]||[],module=$(b.modules[a]),d=module.attr("data-setted");if(n.EVERYTIME==b.widgetMode||"1"!=d){for(var e=0,f=c.length;f>e;e++)!function(a){a.next()}(c[e]);module.attr("data-setted","1")}},restoreModuleWidget:function(a){var b=this,c=b.widgets[String(a)]||[];if(n.EVERYTIME==b.widgetMode)for(var d=0,e=c.length;e>d;d++)c[d].restore()},restoreExceptModuleWidget:function(a){var b=this,c=String(a);if(n.EVERYTIME==b.widgetMode)for(var d in b.widgets)c!=d&&b.restoreModuleWidget(d)},configureLongPageChrome:function(a,c,d,f,g,i){var m=this,n=f.find('[data-chrome-scroller="1"]'),o=n.length>0?n:g,p=Number(f.attr("data-width")),q=Number(f.attr("data-height")),r=g.attr("data-dir"),s=Number(g.attr("data-bound")||150),t=Number(g.attr("data-oversize")||0),u=("1"==g.attr("data-bind"),Number(g.attr("data-width"))),v=Number(g.attr("data-height")),w=u-p+("x"==r?t:0),x=v-q+("x"==r?0:t),y=0,z=0,A=0,B=0,C=0,D=0,E=!1,F="matrix(${a}, ${b}, ${c}, ${d}, ${x}, ${y})",G={a:"1",b:"0",c:"0",d:"1",x:"0",y:"${y}"};if("x"==r){if(G=$.extend(G,{x:"${x}",y:"0"}),p>=u)return m.forcedLock=!1,m.setLocked(!1),0}else if(q>=v)return m.forcedLock=!1,m.setLocked(!1),0;var H=JSON.stringify(G),I={x:"0",y:"0"},J={x:-w,y:-x},K=function(a){var c=JSON.parse(b.formatData(H,a)),d=b.formatData(F,c)+" "+h;e.css(o,"transform",d)};!0===i?(C=D=0,K(I),g.off(),m.exec("chromereset",[a,c,d,f,g,i])):g.on(j,function(b){var e="changedTouches"in b?b.changedTouches[0]:b,h=y=e.pageX,j=z=e.pageY;E=!0,m.exec("chromestart",[a,c,d,f,g,i,h,j,w,x])}).on(l,function(b){if(!E)return 0;var e="changedTouches"in b?b.changedTouches[0]:b,h=e.pageX,j=e.pageY,k=A=h+C-y,l=B=j+D-z,n={x:k,y:l};K(n);var o=!0,p="x"==r?k:l,q="x"==r?w:x;p>0&&p>=s?o=!1:0>p&&Math.abs(p)>=s+q&&(o=!1),m.forcedLock=o,m.setLocked(o),m.exec("chromescrolling",[a,c,d,f,g,i,k,l,w,x])}).on(k,function(b){E=!1;var e=("changedTouches"in b?b.changedTouches[0]:b,C=A),h=D=B,j="x"==r?e:h,k="x"==r?w:x,l=Math.abs(j);j>0?(C=D=0,K(I)):0>j&&l>k&&(C=-w,D=-x,K(J)),m.exec("chromeend",[a,c,d,f,g,i,e,h,w,x])})},createViewFrame:function(a,b,c,d,e,f){var g=this;g.forcedLock=!f,g.setLocked(!f),!0!==f&&g.exec("chromecreatebefore",[a,b,c,d,e,f]),g.updateChrome(d),g.configureLongPageChrome(a,b,c,d,e,f),!0!==f&&g.exec("chromecreate",[a,b,c,d,e,f])},createViewChrome:function(a,b){var c=this,d=$(c.innerboxes[a]),e=d.find('[data-chrome-box="1"]'),f=e.length>0?e:d,g=null,h=f.length,i=null,j=null;if(h>0)for(var k=0;h>k;k++)i=$(f[k]),g=i.find("[data-chrome]"),g.length>0&&(g=$(g[0]),j=g.attr("data-chrome"),c.createViewFrame(k,a,j,i,g,b))},restoreViewChrome:function(a){var b=this;b.createViewChrome(a,!0)},configure:function(){var a=this,b=null;a.preventTouchMove(),b=a.sceneTransition,b.set("interactive",{callback:function(a){var b=this;a&&b.sceneTransition.parseEffectAttributes(b.sceneAttributes).setMoveRatio(b.sceneMoveRatio).setShiftRatio(b.sceneShiftRatio).setTouchEnabled(b.touchEnabled),b.exec("interactive",[a])},context:a}).set("ready",{callback:function(a){this.exec("ready",[a])},context:a}).set("block",{callback:function(a,b){this.exec("block",[a,b])},context:a}).set("start",{callback:function(a,b,c,d,e,f,g){this.currentIndex=g,this.exec("start",[a,b,c,d,e,f,g])},context:a}).set("move",{callback:function(a,b,c,d,e,f,g){this.currentIndex=g,this.exec("scrolling",[a,b,c,d,e,f,g])},context:a}).set("end",{callback:function(a,b,c,d,e,f,g){this.currentIndex=g,this.restoreViewChrome(g),this.exec("exit",[a,b,c,d,e,f,g])},context:a}).set("movement",{callback:function(a,b,c,d,e,f,g,h){this.currentIndex=g,this.exec("movement",[a,b,c,d,e,f,g,h])},context:a}).set("shift",{callback:function(a,b,c,d,e,f,g,h){this.currentIndex=g,this.exec("shift",[a,b,c,d,e,f,g,h])},context:a}).set("visible",{callback:function(a,b){this.refreshChrome(b,!1),this.exec("visible",[a,b])},context:a}).set("complete",{callback:function(a,b){var c=this;c.currentIndex=b,c.createViewChrome(b,!1),c.showModuleWidget(b),c.restoreExceptModuleWidget(b),c.execLazyLoading(b),c.exec("end",[a,b])},context:a}).import()},createViewport:function(){var a=this;a.configure()},resize:function(){var a=this;!0!==a.preventResize&&a.calcLayoutSize()},parseDesignSize:function(){var a=this.app.attr("data-design")||"640/960",b=a.split("/"),c=Number(b[0]),d=Number(b[1]);this.design={width:c,height:d}},setLazyLoading:function(a){this.lazyLoading=a||0},execLazyLoading:function(a){var b=this.modules||[],c=b.length,module=null;if(this.lazyLoading>0)for(var d=a;d<a+this.lazyLoading&&c>d;d++)module=$(b[d]),this.lazy(module)},lazy:function(module){var a=module.find("[data-lazysrc]");$.each(a,function(a,b){var c=$(b),d=c.attr("data-lazysrc"),e=d.indexOf("!"),f=-1!=e?d.substring(0,e):"src",g=-1!=e?d.substring(e+1):d;"src"==f?c.attr("src",g):c.css("background-image","url("+g+")"),c.removeAttr("data-lazysrc")})},create:function(a){var b=this,c=0;b.exec("createbefore",[a]),b.sceneTransition&&(c=b.sceneTransition.getSceneIndex()),b.currentIndex=c,b.parseDesignSize(),b.calcLayoutSize(),b.createViewport(),b.createViewChrome(c,!1),!1!==a&&(b.showModuleWidget(c),b.restoreExceptModuleWidget(c)),b.modules.length<=1&&(b.forcedLock=!0,b.setLocked(!0)),b.execLazyLoading(c),$(window).on("resize","",b,function(a){var b=a.data;b.exec("resize",[a])}).on("orientationchange","",b,function(a){var b=a.data;b.exec("orientationchange",[a])})}};var r={newInstance:function(a,b,c,d){var e=new q(a,b,c,d),g=e.sceneTransition;return{version:"R15B0707",appKey:e.appKey,mode:e.mode,scroll:e.scroll,widgetMode:e.widgetMode,design:e.design,app:e.app,view:e.view,header:e.header,footer:e.footer,modules:e.modules,innerboxes:e.innerboxes,layout:{scale:e.scaleRatio,view:e.viewSize,design:e.designSize,snap:e.snapSize},create:function(a){return e.create(a),this.layout={scale:e.scaleRatio,view:e.viewSize,design:e.designSize,snap:e.snapSize},e.exec("init",[a]),e.exec("create",[a]),e.exec("end",[null,e.currentIndex]),this},getCurrentIndex:function(){return e.currentIndex},set:function(a,b){return e.set(a,b),this},setLocked:function(a){return e.setLocked(a),this},releaseLock:function(){return e.setLocked(!1),this},releaseForceLock:function(){return e.forcedLock=!1,this},setPreventResize:function(a){return e.setPreventResize(a),this},isLocked:function(){return e.locked},isSceneLoop:function(){return e.sceneLoop},isPreventResize:function(){return e.preventResize},isTouchEnabled:function(){return e.touchEnabled},setTouchEnabled:function(a){return e.setTouchEnabled(a),this},getHandleStack:function(){return e.getHandleStack()},getSceneHandleStack:function(){return g.getHandleStack()},setLazyLoading:function(a){return e.setLazyLoading(a),this},execLazyLoading:function(a){return e.execLazyLoading(a),this},updateModuleWidget:function(a){return e.updateModuleWidget(a),this},showModuleWidget:function(a){return e.showModuleWidget(a),this},restoreModuleWidget:function(a){return e.restoreModuleWidget(a),this},restoreExceptModuleWidget:function(a){return e.restoreExceptModuleWidget(a),this},refreshChrome:function(module,a){return e.refreshChrome(module,a),this},updateSceneDeg:function(a){return g.setDeg(a),this},updateSceneDuration:function(a){return g.setDuration(a),this},updateSceneTiming:function(a){return g.setTiming(a),this},updateScenePerspective:function(a){return g.setPerspective(a),this},setSceneIndex:function(a){return g.setSceneIndex(a),this},getSceneIndex:function(){return g.getSceneIndex()},updateEffectAttribute:function(a,b){return g.setEffectAttribute(a,b),this},getEffectAttribute:function(a){return g.getEffectAttribute(a)},updateSceneMoveRatio:function(a){return g.setMoveRatio(a),this},updateSceneShiftRatio:function(a){return g.setShiftRatio(a),this},updateSceneMovableDistance:function(a){return g.setMovableDistance(a),this},getSceneMovableDistance:function(){return g.getMovableDistance()},go:function(a){return g.go(a),this},next:function(){return g.next(),this},prev:function(){return g.prev(),this},resize:function(){return e.resize(),this.layout={scale:e.scaleRatio,view:e.viewSize,design:e.designSize,snap:e.snapSize},this},getTimer:function(a,b,c){return f.getTimer(a,b,c)}}}};module.exports=r});
